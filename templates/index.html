<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>City Layers - Chat to Map</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" />
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <!-- H3 library for hexagonal spatial indexing -->
    <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
    <script>
        window.MAPBOX_TOKEN = "{{ mapbox_token }}";
    </script>
</head>

<body>
    <button id="expandBtn" class="expand-btn" aria-label="Expand panel">▶</button>
    <div class="main-map">
        <div class="left-container">
            <div class="resize-handle"></div>
            <div class="panel category">
                <div class="configheader">
                    <div class="text">
                        <div class="logo-container" style="text-align: center; padding: 10px;">
                            <img src="/static/images/city_layers_logo.png" alt="City Layers Logo"
                                style="max-width: 100%; height: 40px;">
                        </div>
                    </div>
                </div>
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="placeSearchInput" class="place-search-input"
                            placeholder="Search places..." autocomplete="off" />
                        <button type="button" id="clearSearchBtn" class="clear-search-btn"
                            title="Clear search">×</button>
                    </div>
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div id="categoryFilter" class="category-filter-inline">
                    <div class="filter-header-inline">
                        <span>Filter by Category:</span>
                    </div>
                    <div class="filter-controls horizontal">
                        <div class="select-wrapper">
                            <select id="categorySelect" class="category-select minimal-select">
                                <option value="all">All Points</option>
                            </select>
                            <div class="select-arrow"></div>
                        </div>
                        <button type="button" id="applyFilterBtn" class="filter-apply-btn">Filter</button>
                    </div>
                </div>
                <div class="controllercontainer">
                    <div class="subcontainer vis-options-row">
                        <div class="vischoice selected" data-mode="mapbox" id="viz-mapbox" title="Map View">
                            <svg class="viz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                        <div class="vischoice" data-mode="scatter" id="viz-scatter" title="Scatter Plot">
                            <svg class="viz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="2"></circle>
                                <circle cx="19" cy="19" r="2"></circle>
                                <circle cx="5" cy="19" r="2"></circle>
                                <circle cx="5" cy="5" r="2"></circle>
                                <circle cx="19" cy="5" r="2"></circle>
                            </svg>
                        </div>
                        <div class="vischoice" data-mode="heatmap" id="viz-heatmap" title="Heatmap">
                            <svg class="viz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <circle cx="15.5" cy="8.5" r="1.5"></circle>
                                <circle cx="8.5" cy="15.5" r="1.5"></circle>
                                <circle cx="15.5" cy="15.5" r="1.5"></circle>
                            </svg>
                        </div>
                        <div class="vischoice" data-mode="hexagon" id="viz-hexagon" title="Hexagon">
                            <svg class="viz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 7l6-3 6 3 6-3v13l-6 3-6-3-6 3V7z"></path>
                                <path d="M9 4v13"></path>
                                <path d="M15 7v13"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="categorycontainer chat-container">
                    <div id="chatWindow" class="chat-window">
                        <div class="system">Ask questions about places in the database.</div>
                    </div>
                    <button id="scrollBottomBtn" class="scroll-bottom-btn d-none"
                        aria-label="Scroll to bottom"></button>
                    <form id="chatForm" class="chat-form">
                        <button type="button" class="draw-region-icon-btn" id="drawRectangleBtn"
                            title="Draw region on map">
                            <div class="rectangle-icon-small"></div>
                        </button>
                        <input id="chatInput" type="text" placeholder="Type your message..." autocomplete="off" />
                        <button type="submit">Send</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="right-container">
            <div id="map" class="mappanel"></div>
            <div id="map-overlay-panel" class="map-overlay-panel hidden">
                <div class="overlay-header">
                    <span id="overlay-category">Category</span>
                </div>
                <div id="overlay-legend" class="overlay-legend"></div>
            </div>
            <div id="dataSources" class="data-sources-panel">
                <div class="data-sources-header">Data Sources</div>
                <div class="data-sources-list">
                    <button class="data-source-btn active" id="source-citylayers" data-source="citylayers" title="CityLayers - Location data from Neo4j database">
                        <img src="/static/images/city_layers_logo.png" alt="CityLayers" class="source-icon-img">
                    </button>
                    <button class="data-source-btn" id="source-weather" data-source="weather" title="Weather - Temperature and climate data">
                        <svg class="source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        </svg>
                    </button>
                    <button class="data-source-btn" id="source-transport" data-source="transport" title="Transport - Public transport stations and routes">
                        <svg class="source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="6" width="18" height="12" rx="2"></rect>
                            <line x1="8" y1="6" x2="8" y2="2"></line>
                            <line x1="16" y1="6" x2="16" y2="2"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                            <circle cx="8" cy="16" r="1"></circle>
                            <circle cx="16" cy="16" r="1"></circle>
                        </svg>
                    </button>
                </div>
                <div class="data-sources-list" style="margin-top: 5px;">
                    <button class="data-source-btn" id="source-vegetation" data-source="vegetation" title="Vegetation - Trees and green spaces">
                        <svg class="source-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L8 8h8l-4-6z"/>
                            <path d="M9 8L6 13h12l-3-5"/>
                            <rect x="10" y="13" width="4" height="9" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="locationCount" class="location-count-panel">
                <div class="location-count-header">Locations on Map</div>
                <div class="location-count-value">0</div>
            </div>
            <!-- Tabbed Data Panel -->
            <div id="dataPanel" class="data-panel hidden">
                <div class="data-panel-tabs">
                    <div class="data-tab active" data-tab="transport" title="Transport">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="6" width="18" height="12" rx="2"></rect>
                            <path d="M3 10h18"></path>
                            <path d="M8 14h.01"></path>
                            <path d="M16 14h.01"></path>
                            <path d="M3 18l2 2"></path>
                            <path d="M21 18l-2 2"></path>
                        </svg>
                    </div>
                    <div class="data-tab" data-tab="weather" title="Weather">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        </svg>
                    </div>
                    <div class="data-tab" data-tab="trees" title="Trees & Vegetation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L8 8h8l-4-6z"/>
                            <path d="M9 8L6 13h12l-3-5"/>
                            <path d="M10 13v9"/>
                            <path d="M14 13v9"/>
                        </svg>
                    </div>
                </div>
                <div class="data-panel-content">
                    <!-- Transport Tab Content -->
                    <div id="transportTab" class="tab-content active">
                        <div class="transport-legend-items">
                            <div class="transport-legend-item active" data-type="train" title="Train stations">
                                <svg class="transport-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm3.5-7H6V6h5v4zm2 0V6h5v4h-5zm3.5 7c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                                <span class="transport-label">Train</span>
                            </div>
                            <div class="transport-legend-item active" data-type="tram" title="Tram stops">
                                <svg class="transport-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4zm5.5 3H14V3.5h3.5V5zM10 3.5V5H6.5V3.5H10zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm1-5.5v-6h7v6h-7zm8 5.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                                <span class="transport-label">Tram</span>
                            </div>
                            <div class="transport-legend-item active" data-type="bus" title="Bus stops">
                                <svg class="transport-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
                                </svg>
                                <span class="transport-label">Bus</span>
                            </div>
                        </div>
                    </div>
                    <!-- Weather Tab Content -->
                    <div id="weatherTab" class="tab-content">
                        <div class="temperature-info-content">
                            <div class="temperature-header">Temperature</div>
                            <div class="temperature-hover-info">--°C</div>
                            <div class="temperature-value">Avg: --°C</div>
                            <div class="weather-details">
                                <div class="weather-detail-item">
                                    <span class="weather-detail-label">Wind Speed:</span>
                                    <span id="windSpeed" class="weather-detail-value">-- m/s</span>
                                </div>
                                <div class="weather-detail-item">
                                    <span class="weather-detail-label">Direction:</span>
                                    <span id="windDirection" class="weather-detail-value">--°</span>
                                </div>
                            </div>
                            <div class="weather-panel-footer">
                                <button id="popupModeBtn" class="popup-mode-btn" title="Enable popup mode to click on map">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </button>
                                <a href="#" id="accuweatherLink" class="accuweather-link" target="_blank" title="View on AccuWeather">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Trees Tab Content -->
                    <div id="treesTab" class="tab-content">
                        <div class="trees-info-content">
                            <div class="trees-header">Trees & Vegetation</div>
                            <div class="trees-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Total Trees</div>
                                    <div class="stat-value" id="totalTreesCount">--</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Shaded Area</div>
                                    <div class="stat-value" id="shadedAreaCount">--</div>
                                </div>
                            </div>
                            <div class="species-filter-section">
                                <div class="filter-header">Filter by Species</div>
                                <div id="speciesFilterList" class="species-filter-list">
                                    <!-- Species filters will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Location Info Header -->
            <div id="mapControls" class="map-controls-panel">
    <label class="theme-switch" title="Toggle Dark/Light Mode">
        <input type="checkbox" id="themeToggleCheckbox" onchange="toggleTheme()">
        <span class="slider round" data-icon="moon"></span>
    </label>
    <label class="theme-switch" title="Toggle Buildings">
        <input type="checkbox" id="buildingsToggleCheckbox" checked onchange="toggleBuildings()">
        <span class="slider round" data-icon="building"></span>
    </label>
    <button class="map-control-btn" id="clearMapBtn" title="Clear all locations from map">
        <div class="control-icon trash-icon"></div>
    </button>
</div>
            <!-- Compass Overlay -->
            <div id="compassOverlay" class="compass-overlay">
                <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Outer circle -->
                    <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="2" opacity="0.6"/>
                    <!-- Inner circle -->
                    <circle cx="50" cy="50" r="35" fill="none" stroke="currentColor" stroke-width="1" opacity="0.4"/>
                    
                    <!-- Cardinal directions -->
                    <text x="50" y="15" text-anchor="middle" font-size="14" font-weight="bold" fill="currentColor">N</text>
                    <text x="85" y="54" text-anchor="middle" font-size="12" font-weight="bold" fill="currentColor">E</text>
                    <text x="50" y="92" text-anchor="middle" font-size="12" font-weight="bold" fill="currentColor">S</text>
                    <text x="15" y="54" text-anchor="middle" font-size="12" font-weight="bold" fill="currentColor">W</text>
                    
                    <!-- North arrow -->
                    <path d="M 50 10 L 55 30 L 50 25 L 45 30 Z" fill="currentColor" opacity="0.8"/>
                    
                    <!-- Center dot -->
                    <circle cx="50" cy="50" r="3" fill="currentColor" opacity="0.8"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Weather Details Slide-in Panel -->

    <script src="/static/js/app.js?v={{ cache_bust }}"></script>
</body>

</html>